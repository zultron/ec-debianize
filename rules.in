#!/usr/bin/make -f

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

CONFIGURE_OPTS = --prefix=/usr --sysconfdir=/etc --localstatedir=/var \
	--enable-8139too --enable-e100 --enable-e1000 --enable-e1000e \
	--enable-r8169

ALL_UTSNAMES = @ALL_UTSNAMES@

ALL_MODULE_STAMPS = $(foreach u,$(ALL_UTSNAMES),build-stamp-$(u))

build: build-stamp
build-stamp: $(ALL_MODULE_STAMPS)
	dh_testdir
	$(MAKE) all
	touch $@

$(ALL_MODULE_STAMPS): build-stamp-%: build-stamp
	dh_testdir
	./configure \
		$(CONFIGURE_OPTS) \
		--with-linux-dir=/usr/src/linux-headers-$*
	$(MAKE) modules
	$(MAKE) INSTALL_MOD_PATH=`readlink -f debian/tmp` modules_install
	touch $@

configure: configure-stamp
configure-stamp:
	dh_testdir
	./configure \
	    $(CONFIGURE_OPTS)
	touch $@

clean: clean-patched
clean-patched: configure-stamp
	dh_testdir
	dh_testroot
	rm -f configure-stamp build-stamp
	$(MAKE) distclean || true  # breaks
	dh_clean

install: build
	dh_testdir
	dh_testroot
	dh_installdirs

	$(MAKE) DESTDIR=`readlink -f debian/tmp` install

	rm -f $(tmp)/usr/sbin/ethercatctl 
	mv $(tmp)/etc/sysconfig $(tmp)/etc/default

	cp -dR debian/extras/* $(tmp)

	mkdir -p $(tmp)/usr/realtime-@KERNEL_VERSION@/modules/ethercat
	cp Module.symvers $(tmp)/usr/realtime-@KERNEL_VERSION@/modules/ethercat

	dh_install --sourcedir=$(tmp)

