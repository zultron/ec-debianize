#!/usr/bin/make -f

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

TMPDIR = $(CURDIR)/debian/tmp

DEB_UPSTREAM_VERSION=$(shell dpkg-parsechangelog | \
	sed -rne 's,^Version: ([0-9]:)*([^-]+).*,\2,p')

ifneq (,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
PARALLEL = -j$(patsubst parallel=%,%,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
else
PARALLEL =
endif
MAKEFLAGS += $(PARALLEL)

CONFIGURE_OPTS = --prefix=/usr --sysconfdir=/etc --localstatedir=/var \
	--disable-8139too --disable-e100 --disable-e1000 --disable-e1000e \
	--disable-r8169

MODPKG_NAME = igh-ethercat-modules
ALL_UTSNAMES = $(shell \
    awk '/Package: $(MODPKG_NAME)/ { \
	sub("$(MODPKG_NAME)-","",$$2); print $$2 }' \
	debian/control)

BUILD_MODULE_STAMPS = $(foreach u,$(ALL_UTSNAMES),debian/build-stamp-$(u))

configure: debian/configure-stamp
debian/configure-stamp:
	dh_testdir
	test -e configure || ./bootstrap
	./configure --disable-kernel \
	    $(CONFIGURE_OPTS)
	touch $@

debian/build-stamp: debian/configure-stamp
	dh_testdir
	$(MAKE) all
	touch $@

$(BUILD_MODULE_STAMPS): UTSNAME=$*
$(BUILD_MODULE_STAMPS): debian/build-stamp-%: debian/build-stamp
	dh_testdir
	./configure \
		$(CONFIGURE_OPTS) \
		--with-linux-dir=/usr/src/linux-headers-$(UTSNAME)
	$(MAKE) modules
	$(MAKE) INSTALL_MOD_PATH=$(TMPDIR) CONFIG_MODULE_SIG=n modules_install
	mv Module.symvers \
	    $(TMPDIR)/lib/modules/$(UTSNAME)/ethercat

	touch $@

build: debian/build-stamp $(BUILD_MODULE_STAMPS)

clean:
	dh_testdir
	dh_testroot
	rm -f debian/configure-stamp debian/build-stamp debian/build-stamp-*
	[ ! -f Makefile ] || $(MAKE) distclean || true  # breaks
	dh_clean

install: build
	dh_testdir
	dh_testroot
	dh_installdirs
	$(MAKE) DESTDIR=$(TMPDIR) install

	mv $(TMPDIR)/usr/lib/systemd $(TMPDIR)/lib # Debian systemd unit file dir
	rm -r $(TMPDIR)/etc/sysconfig

	cp -a debian/extras/* $(TMPDIR)
	dh_install --sourcedir=$(TMPDIR)


binary-arch: build install
	dh_testdir -a
	dh_testroot -a
	dh_installdocs -a -p igh-ethercat
	dh_installmodules -a
	dh_lintian -a
	dh_strip -a
	dh_link -a
	dh_compress -a
	dh_fixperms -a
	dh_makeshlibs -a
	dh_installdeb -a
	dh_shlibdeps -a
	dh_gencontrol -a
	dh_md5sums -a
	dh_builddeb -a

binary: binary-arch
