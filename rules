#!/usr/bin/make -f

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

TMPDIR = $(CURDIR)/debian/tmp

DEB_UPSTREAM_VERSION=$(shell dpkg-parsechangelog | \
	sed -rne 's,^Version: ([0-9]:)*([^-]+).*,\2,p')

ifneq (,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
PARALLEL = -j$(patsubst parallel=%,%,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
else
PARALLEL =
endif
MAKEFLAGS += $(PARALLEL)

CONFIGURE_OPTS = --prefix=/usr --sysconfdir=/etc --localstatedir=/var \
	--disable-8139too --disable-e100 --disable-e1000 --disable-e1000e \
	--disable-r8169

MODPKG_NAME = igh-ethercat-modules
ALL_UTSNAMES = $(shell \
    awk '/Package: $(MODPKG_NAME)/ { \
	sub("$(MODPKG_NAME)-","",$$2); print $$2 }' \
	debian/control)

BUILD_MODULE_STAMPS = $(foreach u,$(ALL_UTSNAMES),build-stamp-$(u))

configure: configure-stamp
configure-stamp:
	dh_testdir
	test -e configure || ./bootstrap
	./configure --disable-kernel \
	    $(CONFIGURE_OPTS)
	touch $@

build-stamp: configure-stamp
	dh_testdir
	$(MAKE) all
	touch $@

$(BUILD_MODULE_STAMPS): UTSNAME=$*
$(BUILD_MODULE_STAMPS): build-stamp-%: build-stamp
	dh_testdir
	./configure \
		$(CONFIGURE_OPTS) \
		--with-linux-dir=/usr/src/linux-headers-$(UTSNAME)
	$(MAKE) modules
	$(MAKE) INSTALL_MOD_PATH=$(TMPDIR) CONFIG_MODULE_SIG=n modules_install
	mv Module.symvers \
	    $(TMPDIR)/lib/modules/$(UTSNAME)/ethercat

	touch $@

build: build-stamp $(BUILD_MODULE_STAMPS)

clean:
	dh_testdir
	dh_testroot
	rm -f configure-stamp build-stamp build-stamp-*
	[ ! -f Makefile ] || $(MAKE) distclean || true  # breaks
	dh_clean

install: build
	dh_testdir
	dh_testroot
	dh_installdirs
	$(MAKE) DESTDIR=$(TMPDIR) install

	rm -f $(TMPDIR)/usr/sbin/ethercatctl 
	mv $(TMPDIR)/etc/sysconfig $(TMPDIR)/etc/default

	cp -a debian/extras/* $(TMPDIR)
	dh_install --sourcedir=$(TMPDIR)


binary-arch: build install
	dh_testdir -s
	dh_testroot -s
	dh_installdocs -s -p igh-ethercat
	dh_installmodules -s
	dh_lintian -s
	dh_strip -s
	dh_link -s
	dh_compress -s
	dh_fixperms -s
	dh_makeshlibs -s
	dh_installdeb -s
	dh_shlibdeps -s
	dh_gencontrol -s
	dh_md5sums -s
	dh_builddeb -s

binary: binary-arch
